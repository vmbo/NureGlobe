function Point(n,t,i,r){this.key=n;this.x=t;this.y=i;this.z=r;this.E={}}function Graph(n,t){function y(n,t){var u,r,i,f;for(r in n.E)(i=t[r],i.const)||(d=n.E[r],n.mark+d<i.mark&&(i.mark=n.mark+d,i.from=n));u=Number.MAX_VALUE;for(r in t)(i=t[r],i.const)||i.mark<u&&(f=i,u=i.mark);return f}var o,u,h,f,s,i,r,e;this.points={};for(o in n)for(f=o.split(","),u=0;u<f.length;++u)e=f[u],this.points[e]=new Point(e,n[o][0],n[o][1],n[o][2]);for(u=0;u<t.length;u++)for(h=t[u].replace(/,/g," "),f=h.split(" "),s=1;s<f.length;s++)if(i=f[s-1],r=f[s],this.points[i]&&this.points[r]){var c=this.points[i].x-this.points[r].x,l=this.points[i].y-this.points[r].y,a=this.points[i].z-this.points[r].z,v=Math.sqrt(c*c+l*l+a*a);this.points[i].E[r]=this.points[r].E[i]=v}else this.points[i]||console.log("Wrong key: "+i),this.points[r]||console.log("Wrong key: "+r);this.labels=[];for(e in this.points)e[0]!="X"&&e[0]!="L"&&this.labels.push(e);this.labels.sort();this.findNearestPoint=function(n,t,i){var f=Number.MAX_VALUE,e=null,o,u;for(o in this.points){var r=this.points[o],s=r.x-n,h=r.y-t;r.z===i&&(u=s*s+h*h,u<f&&(f=u,e=r))}return e};this.dijkstra=function(n,t){var r=this.points,u,i,f;for(u in r)r[u].mark=Number.MAX_VALUE,r[u].const=!1,r[u].from=null;for(r[n].mark=0,r[n].const=!0,i=r[n];i.key!=t;)i=y(i,r),i||console.log("граф не связен"),i.const=!0;for(i=r[t],f=[i];i.from;)i=i.from,f.push(i);return f}}function Man(){var i=10,r=4,t=0,n;for(this.x=0,this.y=0,this.z=0,this.imgs=[],n=0;n<2;++n)this.imgs[n]=new Image,this.imgs[n].src="pic/man"+(n+1)+".png";this.doStep=function(){t=(t+1)%2};this.draw=function(n){n.drawImage(this.imgs[t],this.x,this.y,r,i)};this.isNear=function(n,t){var u=n-scale*r/2-man.x,f=t-scale*i/2-man.y;return u*u+f*f<400};this.setToPoint=function(n){this.x=n.x;this.y=n.y;this.z=n.z}}function Track(n,t,i){function u(n){var f,i;if(n.length<4)return n;for(f=[n[0]],i=1;i<n.length-1;i++){var r=n[i-1],t=n[i],u=n[i+1],e=r.x==t.x&&t.x==u.x&&r.y==t.y&&t.y==u.y||r.x==t.x&&t.x==u.x&&r.z==t.z&&t.z==u.z||r.z==t.z&&t.z==u.z&&r.y==t.y&&t.y==u.y;e||f.push(t)}return f.push(n[n.length-1]),f}var r=0;this.way=u(i);this.startPoint=this.way[0];this.getCurrentPoint=function(){return this.way[r]};this.stepForward=function(){var t=this.way[r],n;r=(r+1)%this.way.length;n=this.way[r];t.z!=n.z?anime.ladder(t,n):anime.step(t,n)};this.draw=function(n){var t,i;for(n.beginPath(),t=this.way[0],n.moveTo(t.x,t.y),i=1;i<track.way.length;i++)t=this.way[i],n.lineTo(t.x,t.y);n.stroke()}}function Dashboard(){var n=$("#ul-keys"),f=$("#ul-keys-popup"),t=$("#go-button"),i,u,r;n.css("height",$("#canvas-panel").height());n.html("");for(u in graph.labels){r=$("<div class='li-key'>"+graph.labels[u]+"<\/div>");r.on("click",function(){i.text($(this).text());n.popup("close")});n.append(r)}$("#from").on("click",function(){i=$(this);track=null;t.removeClass("ui-icon-man_b").addClass("ui-icon-nureglobe")});$("#to").on("click",function(){i=$(this);track=null;t.removeClass("ui-icon-man_b").addClass("ui-icon-nureglobe")});t.on("click",function(){if(track)track.stepForward();else{var n=$("#from").text(),i=$("#to").text(),r=graph.dijkstra(n,i).reverse();track=new Track(n,i,r);man.setToPoint(track.startPoint);centering(track.startPoint);t.removeClass("ui-icon-nureglobe").addClass("ui-icon-man_b");draw()}});$("#scale-inc").on("click",function(){scale*=1.1;canvas.width=MAP_WIDTH*scale;canvas.height=MAP_HEIGHT*scale;draw()});$("#scale-dec").on("click",function(){scale/=1.1;canvas.width=MAP_WIDTH*scale;canvas.height=MAP_HEIGHT*scale;draw()})}function Anime(){var i=Math.pow(2,1/30),t=this,n;for(this.imgs=[],n=0;n<4;++n)this.imgs[n]=new Image,this.imgs[n].src="pic/ladder"+(n+1)+".png";this.step=function(n,t){var i=10,u=(t.x-n.x)/i,f=(t.y-n.y)/i,r=0,e=setInterval(function(){man.x+=u;man.y+=f;centering(man);draw();r++;r>=i&&(clearInterval(e),man.setToPoint(t),man.i=0,draw())},50)};this.ladder_go_back=function(n,t){var e=n.key[4],i,r;switch(e){case"R":i=2;r=0;break;case"U":i=0;r=-2;break;case"D":i=0;r=2;break;case"L":i=-2;r=0}var f=20,u=0,o=setInterval(function(){u<f/2?(man.x+=i,man.y+=r):(man.x-=i,man.y-=r);draw();u++;u>=f&&(clearInterval(o),man.setToPoint(t),draw())},20)};this.ladder=function(n,i){var f=t.imgs.length,u=n.z<i.z,e=u?[0,1,2,3]:[3,2,1,0],r=0,o=setInterval(function(){r<f&&(man.ladder=t.imgs[e[r]],man.ladder_size=20,man.ladder_x=u?man.x:man.x-man.ladder_size,man.ladder_y=u?man.y-man.ladder_size:man.y);draw();r++;r>=f&&(man.setToPoint(i),man.ladder=null,clearInterval(o),draw())},150)}}function draw(){ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#cccccc";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.save();ctx.scale(scale,scale);var n=man.z;ctx.drawImage(imgs[n],0,0);track&&(ctx.strokeStyle="#FF0000",ctx.lineWidth=2,track.draw(ctx),man.doStep());man.ladder?ctx.drawImage(man.ladder,man.ladder_x,man.ladder_y,man.ladder_size,man.ladder_size):man.draw(ctx);ctx.restore();ctx.fillStyle="rgba(0, 0, 0, 0.25)";ctx.font="72px arial";ctx.fillText(man.z+" этаж",50,VIEW_HEIGHT-50);ctx.fillText(man.z+" этаж",50+VIEW_WIDTH,VIEW_HEIGHT-50);ctx.fillText(man.z+" этаж",50+VIEW_WIDTH+VIEW_WIDTH,VIEW_HEIGHT-50)}function centering(n){$("#canvas-panel").scrollLeft(n.x*scale-screen.width/2);$("#canvas-panel").scrollTop(n.y*scale-screen.height/2)}var dots={"115":[440,294,1],"116":[407,294,1],"118":[388,294,1],"119":[371,294,1],"133":[311.4,213,1],"139":[128,245,1],"X101,142":[128,136,1],"143":[89,136,1],"145":[128,151,1],"146":[128,170,1],"151":[107,294,1],"167":[331,294,1],"113и":[856,261,1],"X107,114,113":[462,294,1],"L102R,148":[128,205,1],"141а":[128,158,1],"141,147":[128,183,1],"140а":[128,217,1],"140,149":[128,231,1],"150,138":[128,263,1],"136,166":[193,294,1],"116а":[423,294,1],"ВХОД":[249,323,1],L104U:[249,260,1],"130а,130,129":[311.4,116,1],"128б":[311.4,126,1],"128а,131":[311.4,141,1],"L105L,127,126":[311.4,155,1],"125а":[311.4,170,1],"131а,125б":[311.4,182,1],"132а":[311.4,193,1],"132б,124":[311.4,204,1],"134,123":[311.4,224,1],"135,122":[311.4,248,1],"135в":[311.4,269,1],"232а":[330,294,2],L103L:[128,276,1],X102:[128,294,1],"X103,165":[166,294,1],X104:[249,294,1],X105:[311,294,1],"X106,120,101,102":[356,294,1],"L101U,144":[29,136,1],X108:[462,316,1],X114:[882,316,1],X113:[882,261,1],X110:[788,261,1],X111:[811,261,1],"X116,114и":[933,261,1],"114аи":[911,261,1],"115и":[966,261,1],"116и":[999,261,1],"121и":[1013,261,1],"117и":[1028,261,1],"120и":[1049,261,1],"119и":[1064,261,1],"L108R,111би":[933,235,1],X115:[933,155,1],"101и":[916,155,1],"102и":[901,155,1],"107и":[882,155,1],"103и":[867,155,1],"X112,105и":[855,155,1],"108и":[840,155,1],"109и,104и":[812,155,1],X109:[788,155,1],L107R:[855,142,1],"111и":[788,184,1],L106L:[811,281,1],"1":[128.5,264,2],"3":[128.5,247,2],"10":[128.5,191,2],"17":[121,144.5,2],"18":[110,144.5,2],"19":[97,144.5,2],"20":[83,144.5,2],"21":[70,144.5,2],"22":[56,144.5,2],"23":[43,144.5,2],"35":[26,31,2],"36":[12,20,2],"212":[357.5,340,2],"222":[527,294,2],"223":[505,294,2],"224":[483,294,2],"225":[462,294,2],"226":[440,294,2],"227":[418,294,2],"229":[396,294,2],"230":[374,294,2],"233":[311.5,253,2],"234":[311.5,240,2],"237":[311.5,170,2],"250":[311.5,262,2],"251":[184,294,2],"258":[46,365,2],"259":[46,386,2],"261":[68,427,2],"262":[82,427,2],"263":[96,427,2],"264":[110,427,2],"268":[166,378,2],"273":[166,402,2],"288":[200,294,2],"L207L,238":[311.5,156,2],"X205,252":[166,294,2],"L204L,255,256,257":[46,344.5,2],"X206,260":[46,427,2],"X202,24":[26,144.5,2],"253,254а,254,253а":[80,294,2],"242,243,241":[311.5,117,2],"244,240":[311.5,129,2],"245,239":[311.5,141,2],"246,236а":[311.5,184,2],"246а,236":[311.5,198,2],"247,235":[311.5,213,2],"249,235а":[311.5,227,2],"215а,217":[357.5,313,2],"214,215,213":[357.5,328,2],"210,211":[357.5,355,2],"208,209":[357.5,368,2],"206,207":[357.5,383,2],"X203,15,13":[128.5,144.5,2],"12,14,16":[128.5,168,2],"9,11,11а":[128.5,176,2],"L202R,6,8":[128.5,206,2],"5,7,7а":[128.5,223,2],"2,4,4а":[128.5,255,2],L206U:[249,260,2],"280,287б":[166,308,2],"280а,287а":[166,317,2],"282,287":[166,327,2],"278,285":[166,336,2],"276,274,283а":[166,348,2],"272,283":[166,360,2],"270,277":[166,370,2],"L205L,277а":[166,388,2],"X207,267,269,274":[166,427,2],"268а":[166,409,2],"266,265":[142,427,2],"264а":[124,427,2],"261а":[53,427,2],"232а":[330,294,2],"252а":[152,294,2],"25,26":[26,116,2],"L201R,27":[26,102,2],"42,28":[26,88,2],"29,41":[26,78,2],"30,40":[26,71,2],"31,39":[26,65,2],"32,38":[26,58,2],"33,34":[26,47,2],"X201,37":[26,20,2],L203L:[128.5,278,2],X204:[128.5,294,2],X208:[249,294,2],X209:[311.5,294,2],"X210,232":[357.5,294,2],"221а":[548,294,2],"X211,L209U,220,221":[576,294,2],L208L:[357,398,2],L210D:[576,350,2],L211D:[852,350,2],L301R:[26,103,3],L302R:[129,206,3],X302:[46,427,3],X303:[129,145,3],L303L:[129,279,3],L304L:[46,346,3],X305:[166,294,3],X304:[129,294,3],L305L:[166,391,3],L306U:[249,265,3],X306:[166,427,3],X307:[249,294,3],L307L:[312,155,3],X308:[312,294,3],L308L:[358,397,3],L309U:[575,294,3],X301:[26,21,3],X309:[358,294,3],L309U:[576,385,3],"19з":[581,385,3],"20з,21з":[616,385,3],"22з":[631,385,3],"23з,24з":[647,385,3],"25з":[691,385,3],"26з":[662,385,3],"26аз":[724,385,3],"28з":[752,385,3],"27з,30з":[781,385,3],"29з":[804,385,3],"31з":[836,385,3],L310U:[852,385,3],"412":[358,315,4],"419":[312,273,4],"420":[312,253,4],"426":[312,226,4],"427":[312,241,4],"428":[312,262,4],"429":[176,295,4],"437":[107,295,4],"440":[46,334,4],"441":[46,365,4],"448":[166,410,4],"453":[166,349,4],L401R:[25,87,4],X401:[127,143,4],"L403L,435,436":[127,279,4],X402:[127,295,4],L402U:[50,143,4],X403:[166,295,4],X404:[249,295,4],X405:[312,295,4],"X406,414,415,416,417":[358,295,4],"438,439":[46,323,4],L404L:[46,345,4],"442,443":[46,426,4],"454,455":[166,315,4],"452а,455а":[166,327,4],"452,455б":[166,339,4],"450а":[166,362,4],"450,451":[166,374,4],"L405L,445":[166,389,4],"445,445а,445б,445в,446,447":[166,427,4],"421,426б":[312,213,4],"422,426а":[312,199,4],"423,424,425":[312,119,4],L407L:[312,157,4],"410а":[358,328,4],"410б,413":[358,340,4],"410,411":[358,355,4],"408,411а":[358,369,4],"406,409":[358,383,4],"L408L,407":[358,395,4],"401,402,403,404,405":[358,412,4],L406U:[249,263,4]},lines=["L101U L402U","L102R L202R L302R","L103L L203L L303L L403L","L104U L206U L306U L406U","L105L L207L L307L L407L","L201R L301R L401R","L204L L304L L404L","L205L L305L L405L","L208L L308L L408L","L210D L309U","L211D L310U","L101U 144 143 142 X101","X101 145 141а 146 141 147 148 L102R 140а 149 140 139 150 138 L103L X102","151 X102 165 X103 136 166 X104 X105 167 X106 101 102 120 119 118 116 116а 115 114 113 X107","130а 130 129 128б 128а 131 127 126 L105L 125а 125б 131а 132а 132б 133 134 123 135 122 135в X105","L104U X104 ВХОД","X107 X108","X108 X114","X114 X113","X111 L106L","X110 X111 113и X113 114аи 114и X116 115и 116и 121и 117и 120и 119и","X109 111и X110","X109 104и 109и 108и 105и X112 103и 107и 102и 101и X115","X115 111би L108R X116","X208 L206U","X202 24 23 22 21 20 19 18 17 15 13 X203","X202 25 26 L201R 27 42 28 29 41 30 40 31 39 32 38 33 34 35 37 X201","X201 36","X203 13 12 14 16 9 11 11а 10 L202R 6 8 5 7 7а 3 2 4 4а 1 L203L X204","253 254 254а 253а X204 252а 252 X205 251 288 X208 X209 232а 232 X210 230 229 227 226 225 224 223 222 221а 220 221 L209U X211","242 243 241 240 244 245 239 238 L207L 237 246 236а 246а 236 247 235 249 235а 234 233 250 X209","X210 215а 217 214 215 213 212 210 211 208 209 206 207 L208L","X205 280 287б 280а 287а 282 287 278 285 276 274 283а 272 283 270 277 268 L205L 277а 273 268а 269 274 X207","X206 261а 261 262 263 264 264а 265 266 267 X207","X206 260 259 258 257 256 255 L204L","X211 L210D","X301 L301R","X303 L302R L303L X304","L304L X302","X302 X306","X305 L305L X306","X304 X305 X307 X308 X309 L309U","L307L X308","X309 L308L","L309U 19з 20з 21з 22з 23з 24з 25з 26з 26аз 28з 27з 30з 29з 31з L310U","438 439 440 L404L 441 442","L403L 435 436 X402","437 X402 X403 429 X404 X405 X406","X403 454 455 452а 455а 452 455б 453 450а 450 451 445 L405L 448 446 447 445 445а 445б 445в","L406U X404","423 424 425 L407L 422 426а 421 426б 426 427 420 428 419 X405","X406 414 415 416 417 412 410а 410б 413 410 411 408 411а 406 409 L408L 407 405 401 402 403 404"],graph=new Graph(dots,lines),man=new Man,anime=new Anime,track=null,ctx,canvas,imgs,imgs_count=4,MAP_HEIGHT,MAP_WIDTH,scale=1,MENU_PANEL_HEIGHT=46,VIEW_WIDTH=$(window).width(),VIEW_HEIGHT=$(window).height()-MENU_PANEL_HEIGHT;$(function(){$("#canvas-panel").css("width",VIEW_WIDTH).css("height",VIEW_HEIGHT);$("#dashboard").css("width",VIEW_WIDTH).css("height",MENU_PANEL_HEIGHT).css("top",VIEW_HEIGHT);imgs={};for(var n=1;n<=imgs_count;++n)imgs[n]=new Image,imgs[n].src="floors/"+n+".svg";imgs[1].onload=function(){MAP_HEIGHT=imgs[1].height;MAP_WIDTH=imgs[1].width;$("#canvas1").attr("width",MAP_WIDTH).attr("height",MAP_HEIGHT);canvas=$("#canvas1")[0];man.setToPoint(graph.points["ВХОД"]);draw()};new Dashboard});